import streamlit as st
import pandas as pd
from openai import OpenAI
import json

# -------------------------------
# Set your OpenAI API key here directly
# -------------------------------
# ‚ö†Ô∏è WARNING: Only use this for testing. Do NOT commit your key to GitHub!
API_KEY = "api key"

# Initialize OpenAI client
client = OpenAI(api_key=API_KEY)

# -------------------------------
# Streamlit App Configuration
# -------------------------------
st.set_page_config(layout="wide")
st.title("üìä AI-Powered Company Fundamental Analysis")

# -------------------------------
# User Input
# -------------------------------
company_name = st.text_input("Enter Company Name", placeholder="e.g., Apple or Microsoft")

# -------------------------------
# AI Analysis Button
# -------------------------------
if st.button("Get Company Analysis"):
    if not company_name:
        st.warning("Please enter a company name to proceed.")
    else:
        with st.spinner(f"üîé Generating AI analysis for {company_name}..."):

            prompt = f"""
            You are a financial research assistant. Provide concise answers (1-2 sentences each) 
            to the following questions for the company "{company_name}":
            1. What does the company do?
            2. Which industry is the company primarily in?
            3. What are its main products or services?
            4. Who are its primary customer segments?
            5. What kind of raw materials or key inputs are required?
            6. Who are its main competitors?
            7. Does the company have any major subsidiaries or affiliated brands?
            8. Does it have a monopoly or is it highly competitive in its main markets?
            Return the output in a JSON array like:
            [
                {{"Q": "question", "A": "answer"}},
                ...
            ]
            """

            try:
                # Use GPT-3.5-turbo
                response = client.chat.completions.create(
                    model="gpt-3.5-turbo",
                    messages=[{"role": "user", "content": prompt}],
                    max_tokens=800
                )

                raw_text = response.choices[0].message.content.strip()

                # Remove code formatting if present
                if raw_text.startswith("```"):
                    raw_text = raw_text.split("```")[-2].strip()

                # Parse JSON response
                data = json.loads(raw_text)
                df = pd.DataFrame(data)

                # Display results
                st.markdown(f"### üìå AI Analysis of {company_name}")
                st.dataframe(df, use_container_width=True)

            except json.JSONDecodeError:
                st.error("‚ö†Ô∏è Failed to parse AI response as JSON. Raw output below:")
                st.text(raw_text)
            except Exception as e:
                err_msg = str(e)
                if "insufficient_quota" in err_msg or "429" in err_msg:
                    st.error("‚ùå API quota exceeded. Check your OpenAI account usage.")
                else:
                    st.error(f"‚ùå AI request failed: {err_msg}")
